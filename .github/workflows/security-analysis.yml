name: Slither Analysis

on:
  #pull_request:
  workflow_dispatch:
    inputs:
      pr_number:
        description: 'PR number to comment on (leave empty for no PR comment)'
        required: false
        type: number
      ref:
        description: 'Git ref to analyze (branch, tag, or SHA). Defaults to current branch'
        required: false
        type: string

jobs:
  analyze:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      security-events: write
      pull-requests: write
    steps:
    - name: Checkout repository
      uses: actions/checkout@v6
      with:
        ref: ${{ inputs.ref || github.ref }}
        fetch-depth: 0
        submodules: recursive

    - name: Install Foundry
      uses: foundry-rs/foundry-toolchain@v1
      with:
        version: nightly
      env:
        FOUNDRY_DISABLE_NIGHTLY_WARNING: true

    - name: Setup Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'

    - name: Install Slither
      run: |
        pip3 install slither-analyzer==0.11.4
        slither --version

    - name: Compile contracts with Foundry
      run: |
        echo "Compiling contracts to reuse artifacts..."
        forge build --build-info
      env:
        FOUNDRY_DISABLE_NIGHTLY_WARNING: true
    
    - name: Run Slither
      id: slither
      continue-on-error: true
      run: |
        # Generate markdown checklist for PR comments (reuse compilation)
        slither contracts/protocol/ \
          --checklist \
          --markdown-root ${{ github.server_url }}/${{ github.repository }}/blob/${{ github.sha }}/ \
          --exclude naming-convention,solc-version,assembly,unimplemented-functions,unindexed-event-address,low-level-calls,dead-code,cyclomatic-complexity,too-many-digits \
          --filter-paths "contracts/test|contracts/mocks|contracts/staking|contracts/governance|contracts/rigoToken|lib/" \
          --ignore-compile \
          > slither-report-raw.md 2>/dev/null || true
        
        # Filter and truncate markdown for PR comment (GitHub limit: 65536 chars)
        if [ -f slither-report-raw.md ]; then
          RAW_SIZE=$(wc -c < slither-report-raw.md)
          echo "Raw markdown size: $RAW_SIZE bytes"
          
          # Remove everything before "INFO:Detectors:" to clean up the report
          if grep -q "INFO:Detectors:" slither-report-raw.md; then
            sed -n '/INFO:Detectors:/,$p' slither-report-raw.md > slither-report-clean.md
          else
            # If no detectors found, keep the raw report
            cp slither-report-raw.md slither-report-clean.md
          fi
          
          CLEAN_SIZE=$(wc -c < slither-report-clean.md)
          echo "Clean markdown size: $CLEAN_SIZE bytes"
          
          # If still too large, truncate and add notice
          if [ "$CLEAN_SIZE" -gt 60000 ]; then
            echo "Report too large, truncating to 60KB..."
            head -c 60000 slither-report-clean.md > slither-report.md
            echo "" >> slither-report.md
            echo "" >> slither-report.md
            echo "---" >> slither-report.md
            echo "**Note:** Report truncated due to size (${CLEAN_SIZE} bytes). See [Security tab](/${{ github.repository }}/security/code-scanning) for full SARIF results." >> slither-report.md
          else
            mv slither-report-clean.md slither-report.md
          fi
          
          FINAL_SIZE=$(wc -c < slither-report.md)
          echo "Final markdown size: $FINAL_SIZE bytes"
        fi
        
        # Generate SARIF for Security tab (reuse compilation)
        slither contracts/protocol/ \
          --sarif results.sarif \
          --exclude naming-convention,solc-version \
          --filter-paths "contracts/test|contracts/mocks|contracts/staking" \
          --ignore-compile \
          2>/dev/null || true
        
        echo "Reports generated"
      env:
        FOUNDRY_DISABLE_NIGHTLY_WARNING: true

    - name: Upload SARIF to Security tab
      uses: github/codeql-action/upload-sarif@v4
      if: (success() || failure()) && steps.slither.outcome != 'cancelled' && hashFiles('results.sarif') != ''
      with:
        sarif_file: results.sarif
        category: slither
      env:
        # Log SARIF file size for debugging
        SARIF_SIZE: ${{ hashFiles('results.sarif') != '' && 'results.sarif exists' || 'results.sarif missing' }}
    
    - name: Log SARIF size
      if: hashFiles('results.sarif') != ''
      run: |
        echo "SARIF file size: $(wc -c < results.sarif) bytes"
        echo "SARIF file location: $(pwd)/results.sarif"

    - name: Create/update checklist as PR comment
      uses: actions/github-script@v7
      if: always() && inputs.pr_number && hashFiles('slither-report.md') != ''
      with:
        script: |
          const fs = require('fs');
          const script = require('.github/scripts/comment');
          const header = '# Slither report';
          const body = fs.readFileSync('slither-report.md', 'utf8');
          
          // Override context.payload.number with manual input
          // Ensure payload object exists before spreading
          const modifiedContext = {
            ...context,
            payload: {
              ...(context.payload || {}),
              number: ${{ inputs.pr_number }}
            }
          };
          
          await script({ github, context: modifiedContext, header, body });

name: Slither Analysis

on:
  #push:
  #  branches: [ main, development ]
  pull_request:
  workflow_dispatch:

jobs:
  analyze:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      security-events: write
      pull-requests: write
    steps:
    - name: Checkout repository
      uses: actions/checkout@v6
      with:
        fetch-depth: 0
        submodules: recursive

    - name: Install Foundry
      uses: foundry-rs/foundry-toolchain@v1
      with:
        version: nightly
      env:
        FOUNDRY_DISABLE_NIGHTLY_WARNING: true

    - name: Setup Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'

    - name: Install Slither
      run: |
        pip3 install slither-analyzer==0.11.4
        slither --version

    - name: Run Slither
      id: slither
      continue-on-error: true
      run: |
        # Generate markdown checklist for PR comments
        slither contracts/protocol/ \
          --checklist \
          --markdown-root ${{ github.server_url }}/${{ github.repository }}/blob/${{ github.sha }}/ \
          --exclude naming-convention,solc-version,assembly,unimplemented-functions,unindexed-event-address,low-level-calls,dead-code,cyclomatic-complexity,too-many-digits \
          --filter-paths "contracts/test|contracts/mocks|contracts/staking|contracts/governance|contracts/rigoToken|lib/" \
          > slither-report-raw.md 2>&1 || true
        
        # Filter and truncate markdown for PR comment (GitHub limit: 65536 chars)
        if [ -f slither-report-raw.md ]; then
          RAW_SIZE=$(wc -c < slither-report-raw.md)
          echo "Raw markdown size: $RAW_SIZE bytes"
          
          # If still too large, truncate and add notice
          if [ "$RAW_SIZE" -gt 60000 ]; then
            echo "Report too large, truncating to 60KB..."
            head -c 60000 slither-report-raw.md > slither-report.md
            echo "" >> slither-report.md
            echo "" >> slither-report.md
            echo "---" >> slither-report.md
            echo "**Note:** Report truncated due to size (${RAW_SIZE} bytes). See [Security tab](/${{ github.repository }}/security/code-scanning) for full SARIF results." >> slither-report.md
          else
            cp slither-report-raw.md slither-report.md
          fi
          
          FINAL_SIZE=$(wc -c < slither-report.md)
          echo "Final markdown size: $FINAL_SIZE bytes"
        fi
        
        # Generate SARIF for Security tab
        slither contracts/protocol/ \
          --sarif results.sarif \
          --exclude naming-convention,solc-version \
          --filter-paths "contracts/test|contracts/mocks|contracts/staking" \
          2>&1 || true
        
        echo "Reports generated"
      env:
        FOUNDRY_DISABLE_NIGHTLY_WARNING: true

    - name: Upload SARIF to Security tab
      uses: github/codeql-action/upload-sarif@v4
      if: (success() || failure()) && steps.slither.outcome != 'cancelled' && hashFiles('results.sarif') != ''
      with:
        sarif_file: results.sarif
        category: slither
      env:
        # Log SARIF file size for debugging
        SARIF_SIZE: ${{ hashFiles('results.sarif') != '' && 'results.sarif exists' || 'results.sarif missing' }}
    
    - name: Log SARIF size
      if: hashFiles('results.sarif') != ''
      run: |
        echo "SARIF file size: $(wc -c < results.sarif) bytes"
        echo "SARIF file location: $(pwd)/results.sarif"

    - name: Create/update checklist as PR comment
      uses: actions/github-script@v7
      if: always() && github.event_name == 'pull_request' && hashFiles('slither-report.md') != ''
      with:
        script: |
          const fs = require('fs');
          const script = require('.github/scripts/comment');
          const header = '# Slither report';
          const body = fs.readFileSync('slither-report.md', 'utf8');
          await script({ github, context, header, body });
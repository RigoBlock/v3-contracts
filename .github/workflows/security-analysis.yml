name: Security Analysis

on:
  pull_request:
    branches:
      - main
      - development
    paths:
      - 'contracts/protocol/**'
      - 'contracts/governance/**'
      - 'contracts/staking/**'
      - '.github/workflows/security-analysis.yml'  # Test workflow changes on PRs
  workflow_dispatch:
    inputs:
      target:
        description: 'Target to analyze (e.g., contracts/protocol/)'
        required: false
        default: 'contracts/protocol/'
      severity:
        description: 'Minimum severity to report'
        required: false
        default: 'all'
        type: choice
        options:
          - all
          - high
          - medium

# Required permissions for security analysis and PR comments
permissions:
  contents: read           # Checkout code
  security-events: write   # Upload SARIF to Security tab
  pull-requests: write     # Post PR comments

# Prevent multiple runs for the same commit
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  slither-analysis:
    name: Slither Static Analysis
    runs-on: ubuntu-latest
    # Skip for dependabot PRs (they don't modify contracts)
    if: github.actor != 'dependabot[bot]'
    
    permissions:
      contents: read
      security-events: write  # Required for GitHub Security tab
      actions: read

    steps:
      - uses: actions/checkout@v6
        with:
          submodules: recursive

      - name: Install Foundry
        uses: foundry-rs/foundry-toolchain@v1
        with:
          version: nightly

      - name: Compile Contracts
        run: forge build --build-info

      - name: Build Slither Arguments
        id: slither-args
        run: |
          BASE_ARGS='--filter-paths "contracts/test|contracts/mocks" --exclude naming-convention,solc-version --ignore-compile'
          SEVERITY="${{ github.event.inputs.severity || 'all' }}"
          
          if [ "$SEVERITY" = "high" ]; then
            EXTRA_ARGS="--exclude-medium --exclude-low --exclude-informational"
          elif [ "$SEVERITY" = "medium" ]; then
            EXTRA_ARGS="--exclude-low --exclude-informational"
          else
            EXTRA_ARGS=""
          fi
          
          echo "args=$BASE_ARGS $EXTRA_ARGS" >> $GITHUB_OUTPUT

      - name: Run Slither on Protocol
        uses: crytic/slither-action@v0.4.0
        id: slither-protocol
        continue-on-error: true
        with:
          target: ${{ github.event.inputs.target || 'contracts/protocol/' }}
          slither-args: ${{ steps.slither-args.outputs.args }}
          sarif: results-protocol.sarif
          fail-on: none

      - name: Upload Protocol SARIF file
        uses: github/codeql-action/upload-sarif@v4
        if: always()
        with:
          sarif_file: ${{ steps.slither-protocol.outputs.sarif }}
          category: slither-protocol

      - name: Generate Markdown Report
        if: always()
        run: |
          TARGET="${{ github.event.inputs.target || 'contracts/protocol/' }}"
          SEVERITY="${{ github.event.inputs.severity || 'all' }}"
          
          echo "## ðŸ” Slither Static Analysis Report" > slither-report.md
          echo "" >> slither-report.md
          echo "Analysis completed for: \`$TARGET\`" >> slither-report.md
          echo "" >> slither-report.md
          echo "ðŸ“Š **Results uploaded to GitHub Security tab** â†’ [View Security Alerts](https://github.com/${{ github.repository }}/security/code-scanning)" >> slither-report.md
          echo "" >> slither-report.md
          echo "### Configuration" >> slither-report.md
          echo "- **Target**: $TARGET" >> slither-report.md
          echo "- **Severity filter**: $SEVERITY" >> slither-report.md
          echo "- **Excluded**: Test files, mocks, naming conventions, solc version warnings" >> slither-report.md
          echo "- **Mode**: Non-blocking (informational)" >> slither-report.md
          echo "" >> slither-report.md
          echo "### Report Storage" >> slither-report.md
          echo "- **GitHub Security Tab**: Permanent record of all findings" >> slither-report.md
          echo "- **SARIF Format**: Machine-readable, integrated with GitHub code scanning" >> slither-report.md
          echo "- **Tracks Over Time**: See when issues were introduced/fixed" >> slither-report.md
          
      - name: Comment PR with Report Link
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const report = fs.readFileSync('slither-report.md', 'utf8');
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: report
            });

name: Security Analysis

on:
  # Run after main CI completes to avoid compiler download conflicts
  # This triggers for ALL branches including PRs, so Slither runs after CI finishes
  workflow_run:
    workflows: ["v3-contracts"]
    types:
      - completed

  # Manual trigger for on-demand analysis
  workflow_dispatch:
    inputs:
      target:
        description: 'Target to analyze (e.g., contracts/protocol/)'
        required: false
        default: 'contracts/protocol/'
      severity:
        description: 'Minimum severity to report'
        required: false
        default: 'all'
        type: choice
        options:
          - all
          - high
          - medium

# Required permissions for security analysis
permissions:
  contents: read           # Checkout code
  security-events: write   # Upload SARIF to Security tab
  pull-requests: write     # Post PR comments

# Prevent multiple runs for the same commit
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  slither-analysis:
    name: Slither Static Analysis
    runs-on: ubuntu-latest
    # Skip for dependabot PRs (they don't modify contracts)
    if: github.actor != 'dependabot[bot]'
    
    permissions:
      contents: read
      security-events: write  # Required for GitHub Security tab
      pull-requests: write    # Required for PR comments
      actions: read

    steps:
      - uses: actions/checkout@v6
        with:
          ref: ${{ github.event.workflow_run.head_sha }}
          submodules: recursive

      - name: Install Foundry
        uses: foundry-rs/foundry-toolchain@v1
        with:
          version: nightly

      - name: Build Slither Arguments
        id: slither-args
        run: |
          BASE_ARGS='--filter-paths "lib/|node_modules/" --exclude naming-convention,solc-version'
          SEVERITY="${{ github.event.inputs.severity || 'all' }}"
          # Add markdown output for PR comments
          if [ "${{ github.event.workflow_run.event }}" = "pull_request" ]; then
            BASE_ARGS="$BASE_ARGS --checklist --markdown-root ${{ github.server_url }}/${{ github.repository }}/blob/${{ github.event.workflow_run.head_sha }}/"
          fi
          
          if [ "$SEVERITY" = "high" ]; then
            EXTRA_ARGS="--exclude-medium --exclude-low --exclude-informational"
          elif [ "$SEVERITY" = "medium" ]; then
            EXTRA_ARGS="--exclude-low --exclude-informational"
          else
            EXTRA_ARGS=""
          fi
          
          echo "args=$BASE_ARGS $EXTRA_ARGS" >> $GITHUB_OUTPUT

      - name: Run Slither on Protocol
        uses: crytic/slither-action@v0.4.1
        id: slither-protocol
        with:
          target: ${{ github.event.inputs.target || 'contracts/protocol/' }}
          slither-args: ${{ steps.slither-args.outputs.args }}
          sarif: results-protocol.sarif
          fail-on: none

      - name: Debug Slither Output
        if: always()
        run: |
          echo "=== Slither Execution Status ==="
          echo "Exit code: ${{ steps.slither-protocol.outcome }}"
          echo "SARIF output path: ${{ steps.slither-protocol.outputs.sarif }}"
          echo ""
          echo "=== Files in workspace ==="
          ls -la
          echo ""
          if [ -f "results-protocol.sarif" ]; then
            echo "‚úÖ SARIF file exists"
            echo "Size: $(wc -c < results-protocol.sarif) bytes"
          else
            echo "‚ùå SARIF file does NOT exist"
          fi
          echo ""
          echo "=== Slither stdout (first 50 lines) ==="
          echo "${{ steps.slither-protocol.outputs.stdout }}" | head -n 50 || echo "No stdout available"

      - name: Upload Protocol SARIF file
        uses: github/codeql-action/upload-sarif@v4
        if: always() && hashFiles('results-protocol.sarif') != ''
        with:
          sarif_file: results-protocol.sarif
          category: slither-protocol

      - name: Parse Slither Results
        if: always()
        id: parse-results
        run: |
          if [ -f "results-protocol.sarif" ]; then
            # Count alerts in SARIF file
            ALERT_COUNT=$(jq '[.runs[].results // []] | add | length' results-protocol.sarif 2>/dev/null || echo "0")
            echo "alert_count=$ALERT_COUNT" >> $GITHUB_OUTPUT
            
            # Generate summary
            if [ "$ALERT_COUNT" = "0" ]; then
              echo "status=‚úÖ No security issues found" >> $GITHUB_OUTPUT
            else
              echo "status=‚ö†Ô∏è Found $ALERT_COUNT security alert(s)" >> $GITHUB_OUTPUT
            fi
          else
            echo "alert_count=unknown" >> $GITHUB_OUTPUT
            echo "status=‚ùì SARIF file not generated" >> $GITHUB_OUTPUT
          fi

      - name: Upload Slither Report Artifact
        if: always() && hashFiles('results-protocol.sarif') != ''
        uses: actions/upload-artifact@v4
        with:
          name: slither-report-${{ github.run_id }}
          path: |
            results-protocol.sarif
            slither.db.json
          retention-days: 30

      - name: Create/update PR comment with Slither report
        uses: actions/github-script@v7
        if: github.event.workflow_run.event == 'pull_request'
        env:
          REPORT: ${{ steps.slither-protocol.outputs.stdout }}
        with:
          script: |
            const header = '# üîç Slither Static Analysis Report';
            const report = process.env.REPORT || 'No output from Slither';
            const alertCount = '${{ steps.parse-results.outputs.alert_count }}';
            const status = '${{ steps.parse-results.outputs.status }}';
            
            // Get PR number from workflow_run pull_requests
            const pullRequests = ${{ toJSON(github.event.workflow_run.pull_requests) }};
            
            console.log('Workflow run event:', '${{ github.event.workflow_run.event }}');
            console.log('Pull requests:', JSON.stringify(pullRequests));
            console.log('Head branch:', '${{ github.event.workflow_run.head_branch }}');
            
            if (!pullRequests || pullRequests.length === 0) {
              console.log('‚ö†Ô∏è No pull request found in workflow_run context - trying to find PR by commit SHA');
              
              // Fallback: search for PR by commit SHA
              const { data: prs } = await github.rest.repos.listPullRequestsAssociatedWithCommit({
                owner: context.repo.owner,
                repo: context.repo.repo,
                commit_sha: '${{ github.event.workflow_run.head_sha }}'
              });
              
              if (prs.length === 0) {
                console.log('‚ùå No PR found for this commit - skipping PR comment');
                return;
              }
              
              const prNumber = prs[0].number;
              console.log('‚úÖ Found PR #' + prNumber + ' via commit SHA');
              
              const body = `${header}
              
              **Status:** ${status}
              **Alerts:** ${alertCount}
              
              <details>
              <summary>üìä Full Slither Report</summary>
              
              \`\`\`text
              ${report}
              \`\`\`
              
              </details>
              
              ---
              üîó [View in Security Tab](https://github.com/${{ github.repository }}/security/code-scanning) | üì¶ [Download SARIF](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})
              `;
              
              const { data: comments } = await github.rest.issues.listComments({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: prNumber,
              });
              
              const botComment = comments.find(
                (comment) =>
                  comment.user &&
                  comment.user.type === 'Bot' &&
                  comment.user.login === 'github-actions[bot]' &&
                  comment.body.startsWith(header)
              );
              
              if (botComment) {
                await github.rest.issues.updateComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  comment_id: botComment.id,
                  body: body,
                });
                console.log('‚úÖ Updated existing comment');
              } else {
                await github.rest.issues.createComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: prNumber,
                  body: body,
                });
                console.log('‚úÖ Created new comment');
              }
              return;
            }
            
            const prNumber = pullRequests[0].number;
            console.log('‚úÖ Found PR #' + prNumber + ' from workflow_run context');
            
            const body = `${header}
            
            **Status:** ${status}
            **Alerts:** ${alertCount}
            
            <details>
            <summary>üìä Full Slither Report</summary>
            
            \`\`\`text
            ${report}
            \`\`\`
            
            </details>
            
            ---
            üîó [View in Security Tab](https://github.com/${{ github.repository }}/security/code-scanning) | üì¶ [Download SARIF](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})
            `;
            
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
            });
            
            const botComment = comments.find(
              (comment) =>
                comment.user &&
                comment.user.type === 'Bot' &&
                comment.user.login === 'github-actions[bot]' &&
                comment.body.startsWith(header)
            );
            
            if (botComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: body,
              });
              console.log('‚úÖ Updated existing comment');
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: prNumber,
                body: body,
              });
              console.log('‚úÖ Created new comment');
            }

      - name: Analysis Complete
        if: always()
        run: |
          echo "‚úÖ Slither analysis complete"
          echo "üìä Results: ${{ steps.parse-results.outputs.status }}"
          echo ""
          echo "üîç View in Security tab: https://github.com/${{ github.repository }}/security/code-scanning"
          echo "üì¶ Download full report: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          echo ""
          echo "Target: ${{ github.event.inputs.target || 'contracts/protocol/' }}"
          echo "Severity: ${{ github.event.inputs.severity || 'all' }}"
          echo ""
          if [ "${{ steps.parse-results.outputs.alert_count }}" = "0" ]; then
            echo "‚úÖ No alerts found - Security tab will be empty (this is good!)"
          fi
          if [ "${{ github.event.workflow_run.event }}" = "pull_request" ]; then
            echo "üí¨ PR comment posted with full markdown report"
          fi

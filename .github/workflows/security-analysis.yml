name: Security Analysis

on:
  # Trigger on PRs to show results as comments
  pull_request:
    paths:
      - 'contracts/protocol/**'
      - 'contracts/governance/**'
      - 'contracts/staking/**'
      - '.github/workflows/security-analysis.yml'
  
  # Run after main CI completes to avoid compiler download conflicts
  workflow_run:
    workflows: ["v3-contracts"]
    types:
      - completed
    branches:
      - main
      - development

  # Manual trigger for on-demand analysis
  workflow_dispatch:
    inputs:
      target:
        description: 'Target to analyze (e.g., contracts/protocol/)'
        required: false
        default: 'contracts/protocol/'
      severity:
        description: 'Minimum severity to report'
        required: false
        default: 'all'
        type: choice
        options:
          - all
          - high
          - medium

# Required permissions for security analysis
permissions:
  contents: read           # Checkout code
  security-events: write   # Upload SARIF to Security tab
  pull-requests: write     # Post PR comments

# Prevent multiple runs for the same commit
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  slither-analysis:
    name: Slither Static Analysis
    runs-on: ubuntu-latest
    # Skip for dependabot PRs (they don't modify contracts)
    if: github.actor != 'dependabot[bot]'
    
    permissions:
      contents: read
      security-events: write  # Required for GitHub Security tab
      pull-requests: write    # Required for PR comments
      actions: read

    steps:
      - uses: actions/checkout@v6
        with:
          submodules: recursive

      - name: Install Foundry
        uses: foundry-rs/foundry-toolchain@v1
        with:
          version: nightly

      - name: Compile Contracts
        run: forge build --build-info

      - name: Build Slither Arguments
        id: slither-args
        run: |
          BASE_ARGS='--filter-paths "contracts/test|contracts/mocks" --exclude naming-convention,solc-version --ignore-compile'
          SEVERITY="${{ github.event.inputs.severity || 'all' }}"
          # Add markdown output for PR comments
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            BASE_ARGS="$BASE_ARGS --checklist --markdown-root ${{ github.server_url }}/${{ github.repository }}/blob/${{ github.sha }}/"
          fi
          
          
          if [ "$SEVERITY" = "high" ]; then
            EXTRA_ARGS="--exclude-medium --exclude-low --exclude-informational"
          elif [ "$SEVERITY" = "medium" ]; then
            EXTRA_ARGS="--exclude-low --exclude-informational"
          else
            EXTRA_ARGS=""
          fi
          
          echo "args=$BASE_ARGS $EXTRA_ARGS" >> $GITHUB_OUTPUT

      - name: Run Slither on Protocol
        uses: crytic/slither-action@v0.4.0
        id: slither-protocol
        continue-on-error: true
        with:
          target: ${{ github.event.inputs.target || 'contracts/protocol/' }}
          slither-args: ${{ steps.slither-args.outputs.args }}
          sarif: results-protocol.sarif
          fail-on: none

      - name: Upload Protocol SARIF file
        uses: github/codeql-action/upload-sarif@v4
        if: always()
        with:
          sarif_file: ${{ steps.slither-protocol.outputs.sarif }}
          category: slither-protocol

      - name: Parse Slither Results
        if: always()
        id: parse-results
        run: |
          if [ -f "results-protocol.sarif" ]; then
            # Count alerts in SARIF file
            ALERT_COUNT=$(jq '[.runs[].results // []] | add | length' results-protocol.sarif 2>/dev/null || echo "0")
            echo "alert_count=$ALERT_COUNT" >> $GITHUB_OUTPUT
            
            # Generate summary
            if [ "$ALERT_COUNT" = "0" ]; then
              echo "status=âœ… No security issues found" >> $GITHUB_OUTPUT
            else
              echo "status=âš ï¸ Found $ALERT_COUNT security alert(s)" >> $GITHUB_OUTPUT
            fi
          else
            echo "alert_count=unknown" >> $GITHUB_OUTPUT
            echo "status=â“ SARIF file not generated" >> $GITHUB_OUTPUT
          fi

      - name: Upload Slither Report Artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: slither-report-${{ github.run_id }}
          path: |
            results-protocol.sarif
            slither.db.json
          retention-days: 30

      - name: Create/update PR comment with Slither report
        uses: actions/github-script@v7
        if: github.event_name == 'pull_request'
        env:
          REPORT: ${{ steps.slither-protocol.outputs.stdout }}
        with:
          script: |
            const header = '# ğŸ” Slither Static Analysis Report';
            const report = process.env.REPORT || 'No output from Slither';
            const alertCount = '${{ steps.parse-results.outputs.alert_count }}';
            const status = '${{ steps.parse-results.outputs.status }}';
            
            const body = `${header}
            
            **Status:** ${status}
            **Alerts:** ${alertCount}
            
            <details>
            <summary>ğŸ“Š Full Slither Report</summary>
            
            ${report}
            
            </details>
            
            ---
            ğŸ”— [View in Security Tab](https://github.com/${{ github.repository }}/security/code-scanning) | ğŸ“¦ [Download SARIF](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})
            `;
            
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });
            
            const botComment = comments.find(
              (comment) => comment.user.id === 41898282 && comment.body.startsWith(header)
            );
            
            if (botComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: body,
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: body,
              });
            }

      - name: Analysis Complete
        if: always()
        run: |
          echo "âœ… Slither analysis complete"
          echo "ğŸ“Š Results: ${{ steps.parse-results.outputs.status }}"
          echo ""
          echo "ğŸ” View in Security tab: https://github.com/${{ github.repository }}/security/code-scanning"
          echo "ğŸ“¦ Download full report: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          echo ""
          echo "Target: ${{ github.event.inputs.target || 'contracts/protocol/' }}"
          echo "Severity: ${{ github.event.inputs.severity || 'all' }}"
          echo ""
          if [ "${{ steps.parse-results.outputs.alert_count }}" = "0" ]; then
            echo "âœ… No alerts found - Security tab will be empty (this is good!)"
          fi
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            echo "ğŸ’¬ PR comment posted with full markdown report"
          fi

name: Security Analysis

on:
  # Run after main CI completes to avoid compiler download conflicts
  # This triggers for ALL branches including PRs, so Slither runs after CI finishes
  workflow_run:
    workflows: ["v3-contracts"]
    types:
      - completed

  # Manual trigger for on-demand analysis
  workflow_dispatch:
    inputs:
      target:
        description: 'Target to analyze (e.g., contracts/protocol/)'
        required: false
        default: 'contracts/protocol/'
      severity:
        description: 'Minimum severity to report'
        required: false
        default: 'all'
        type: choice
        options:
          - all
          - high
          - medium

# Required permissions for security analysis
permissions:
  contents: read           # Checkout code
  security-events: write   # Upload SARIF to Security tab
  pull-requests: write     # Post PR comments

# Prevent multiple runs for the same commit
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  slither-analysis:
    name: Slither Static Analysis
    runs-on: ubuntu-latest
    # Skip for dependabot PRs (they don't modify contracts)
    if: github.actor != 'dependabot[bot]'
    
    permissions:
      contents: read
      security-events: write  # Required for GitHub Security tab
      pull-requests: write    # Required for PR comments
      actions: read

    steps:
      - uses: actions/checkout@v6
        with:
          submodules: recursive

      - name: Install Foundry
        uses: foundry-rs/foundry-toolchain@v1
        with:
          version: nightly

      - name: Run Slither on Protocol
        uses: crytic/slither-action@v0.4.1
        id: slither-protocol
        with:
          target: ${{ github.event.inputs.target || 'contracts/protocol/' }}
          slither-args: --exclude naming-convention,solc-version
          sarif: results-protocol.sarif
          fail-on: none

      - name: Debug Slither Output
        if: always()
        run: |
          echo "=== Slither Execution Status ==="
          echo "Exit code: ${{ steps.slither-protocol.outcome }}"
          echo "SARIF output path: ${{ steps.slither-protocol.outputs.sarif }}"
          echo ""
          echo "=== Files in workspace ==="
          ls -la
          echo ""
          if [ -f "results-protocol.sarif" ]; then
            echo "SARIF file exists"
            echo "Size: $(wc -c < results-protocol.sarif) bytes"
          else
            echo "SARIF file does NOT exist"
          fi
          echo ""
          echo "=== Slither stdout (first 50 lines) ==="
          echo "${{ steps.slither-protocol.outputs.stdout }}" | head -n 50 || echo "No stdout available"

      - name: Upload Protocol SARIF file
        uses: github/codeql-action/upload-sarif@v4
        if: always() && hashFiles('results-protocol.sarif') != ''
        with:
          sarif_file: results-protocol.sarif
          category: slither-protocol

      - name: Parse Slither Results
        if: always()
        id: parse-results
        run: |
          if [ -f "results-protocol.sarif" ]; then
            # Count alerts in SARIF file
            ALERT_COUNT=$(jq '[.runs[].results // []] | add | length' results-protocol.sarif 2>/dev/null || echo "0")
            echo "alert_count=$ALERT_COUNT" >> $GITHUB_OUTPUT
            
            # Generate summary
            if [ "$ALERT_COUNT" = "0" ]; then
              echo "status=No security issues found" >> $GITHUB_OUTPUT
            else
              echo "status=Found $ALERT_COUNT security alert(s)" >> $GITHUB_OUTPUT
            fi
          else
            echo "alert_count=unknown" >> $GITHUB_OUTPUT
            echo "status=SARIF file not generated" >> $GITHUB_OUTPUT
          fi

      - name: Upload Slither Report Artifact
        if: always() && hashFiles('results-protocol.sarif') != ''
        uses: actions/upload-artifact@v4
        with:
          name: slither-report-${{ github.run_id }}
          path: |
            results-protocol.sarif
            slither.db.json
          retention-days: 30

      - name: Create/update PR comment with Slither report
        uses: actions/github-script@v7
        if: github.event.workflow_run.event == 'pull_request'
        env:
          REPORT: ${{ steps.slither-protocol.outputs.stdout }}
        with:
          script: |
            const script = require('./.github/scripts/comment');
            const header = '# Slither Static Analysis Report';
            const status = '${{ steps.parse-results.outputs.status }}';
            const alertCount = '${{ steps.parse-results.outputs.alert_count }}';
            const report = process.env.REPORT || 'No output from Slither';
            
            const body = '**Status:** ' + status + '\n**Alerts:** ' + alertCount + '\n\n<details>\n<summary>Full Slither Report</summary>\n\n```text\n' + report + '\n```\n\n</details>\n\n---\nView in Security Tab: https://github.com/${{ github.repository }}/security/code-scanning\nDownload SARIF: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}';
            
            // Get PR number from workflow_run context
            const pullRequests = ${{ toJSON(github.event.workflow_run.pull_requests) }};
            if (!pullRequests || pullRequests.length === 0) {
              console.log('No PR found in workflow_run context - skipping comment');
              return;
            }
            
            // Override context.payload.number for the script
            context.payload.number = pullRequests[0].number;
            
            await script({ github, context, header, body });

      - name: Analysis Complete
        if: always()
        run: |
          echo "Slither analysis complete"
          echo "Results: ${{ steps.parse-results.outputs.status }}"
          echo ""
          echo "View in Security tab: https://github.com/${{ github.repository }}/security/code-scanning"
          echo "Download full report: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          echo ""
          echo "Target: ${{ github.event.inputs.target || 'contracts/protocol/' }}"
          echo "Severity: ${{ github.event.inputs.severity || 'all' }}"
          echo ""
          if [ "${{ steps.parse-results.outputs.alert_count }}" = "0" ]; then
            echo "No alerts found - Security tab will be empty (this is good!)"
          fi
          if [ "${{ github.event.workflow_run.event }}" = "pull_request" ]; then
            echo "PR comment posted with full markdown report"
          fi
